<!DOCTYPE html>
<html lang="es-MX">
<head>
  <meta charset="UTF-8" />
  <title> Algoritmo de Dijkstra/Editor de grafos/Animador </title>
  <link rel="stylesheet" href="theme.css" />
</head>
<body>

<!-- App [Vector graphics -> Sidebar -> ] -->
<!-- Sidebar [Controls [Buttons -> Speed ] ]-->
<!-- App elements declaration; buttons are untested and visual glitches might be present -->
<div class="app">

  <div class="stage-wrap">
    <svg id="stage" viewBox="0 0 1600 900" preserveAspectRatio="xMidYMid meet">
      <g id="edges"></g>
      <g id="edge-labels"></g>
      <g id="nodes"></g>
      <g id="node-labels"></g>
    </svg>
  </div>


  <aside id="sidebar" aria-hidden="false">
    <button id="toggleSidebarBtn" style="margin-bottom:10px;">Ocultar panel</button>
    <h2>Algoritmo de Dijkstra</h2>

    <!-- Controls [Buttons, Speed selector... et ceatera]-->
    <div class="controls">
      <select id="sourceSelect" title="Origen"></select>
      <button id="resetBtn">Reiniciar</button>
      <button id="playBtn" class="primary">Animar</button>
      <button id="stopBtn" disabled>Detener</button>
    </div>

    <div class="controls">
      <label for="speedSelect">Velocidad:</label>
      <select id="speedSelect">
        <option value="1200">Lenta</option>
        <option value="600" selected>Media</option>
        <option value="300">Rápida</option>
      </select>
    </div>

    <div class="controls">
      <button id="savePresetBtn">Guardar</button>
      <button id="copyPresetBtn">Copiar</button>
      <button id="loadPresetBtn">Cargar</button>
    </div>

    <div class="controls">
      <label style="color:var(--accent); display:flex; gap:6px; align-items:center;">
        <input type="checkbox" id="loopToggle" style="accent-color:var(--accent);" />
        Repetir
      </label>
    </div>

    <button class="help-btn" id="helpBtn">?</button>

    <label for="presetBox" class="visually-hidden">Preset JSON</label>
    <textarea id="presetBox" class="preset" placeholder='Pegue/cargue un preset JSON { "nodes":[{"id":"A","x":320,"y":240},{"id":"B","x":760,"y":180}], "edges":[{"a":"A","b":"B","w":2}],  "sourceId":"A" }'></textarea>
    <p class="hint">Edición: clic para crear nodo · Ctrl+arrastrar para mover · Clic y arrastre entre nodos para arista · Doble clic en nodo/arista para editar · Shift+clic para eliminar.</p>

    <h2 style="margin-top:14px">Tabla de distancias</h2>
    <table>
      <thead><tr><th>Nodo</th><th>Distancia</th><th>Camino</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </aside>


  <div id="sidebar-resizer"></div>
  <div class="badge">ESC -> regresar</div>


</div>

<div class="help-overlay" id="helpOverlay" aria-hidden="true">
  <div class="help-card">
    <img src="help.svg" alt="Ayuda">
  </div>
</div>

<!--JS [Utilities -> Html Wiring -> Editor]-->
<script src="utils.js"></script>

<script>

  (function () {
    const $ = s => document.querySelector(s);
    const stageEl = $('#stage');


    /* Hide Sidebar Button */
    const toggleSidebarBtn = $('#toggleSidebarBtn');
    const sidebar = $('#sidebar');
    const root = document.documentElement;
    let sidebarVisible = true;

    toggleSidebarBtn.onclick = () => {
      sidebarVisible = !sidebarVisible;

      if (sidebarVisible) {
        sidebar.style.display = "block";
        root.style.setProperty('--drawer-width', '420px');
        toggleSidebarBtn.textContent = "Ocultar panel";
      } else {
        sidebar.style.display = "none";
        root.style.setProperty('--drawer-width', '0px');
        toggleSidebarBtn.textContent = "Mostrar panel";
      }
    };

    window.addEventListener('keydown', (e) => {
      if (e.key === "Escape") {
        if (sidebarVisible)
          return;
        sidebarVisible = true;
        sidebar.style.display = "block";
        root.style.setProperty('--drawer-width', '420px');
        toggleSidebarBtn.textContent = "Ocultar panel";
      }
    });

    /* Utilities bound first to the DOM -dependent-> Editor */
    Utils.setState({
      svg: {
        root: stageEl,
        gEdges: $('#edges'),
        gEdgeLabels: $('#edge-labels'),
        gNodes: $('#nodes'),
        gNodeLabels: $('#node-labels'),
      },
      tableEl: $('#rows'),
      loop: false
    });

    Utils.attachHoverHandlers(stageEl);

    const S = Utils.state;
    const sourceSelect   = $('#sourceSelect');
    const resetBtn       = $('#resetBtn');
    const playBtn        = $('#playBtn');
    const stopBtn        = $('#stopBtn');
    const savePresetBtn  = $('#savePresetBtn');
    const copyPresetBtn  = $('#copyPresetBtn');
    const loadPresetBtn  = $('#loadPresetBtn');
    const presetBox      = $('#presetBox');
    const speedSelect    = $('#speedSelect');

    const loopToggle = document.getElementById('loopToggle');
    loopToggle.onchange = () => { S.loop = loopToggle.checked; };

    let speed = Number(speedSelect.value);
    speedSelect.onchange = () => speed = Number(speedSelect.value);

    playBtn.onclick = () => {
      S.loop = loopToggle.checked;
      if (!S.animating) Utils.animateDijkstra(speed);
    };

    stopBtn.onclick = () => {
      S.loop = false;
      S.animating = false;
      if (S.cancelAnim) clearTimeout(S.cancelAnim);
    };



    function renderSourceOptions() {
      sourceSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = ''; placeholder.textContent = '— Origen —';
      sourceSelect.appendChild(placeholder);
      (S.nodes || []).forEach(n => {
        const o = document.createElement('option');
        o.value = n.id; o.textContent = n.id;
        if (n.id === S.sourceId) o.selected = true;
        sourceSelect.appendChild(o);
      });
    }

    function refresh() {
      const { dist, prev } = Utils.runDijkstra(S.nodes || [], S.edges || [], S.sourceId || null);
      Utils.drawGraph(dist, prev);
      Utils.renderTable(dist, prev);
      renderSourceOptions();
    }

    window.addEventListener('graph-changed', renderSourceOptions);
    sourceSelect.onchange = () => { S.sourceId = sourceSelect.value || null; refresh(); };

    /* Preset manager */
    function exportPreset() {
      return JSON.stringify({ nodes: S.nodes||[], edges: S.edges||[], sourceId: S.sourceId||null }, null, 2);
    }

    function importPreset(txt) {
      const obj = JSON.parse(txt);
      S.nodes = (obj.nodes||[]).map(n => ({ id:String(n.id), x:+n.x, y:+n.y }));
      S.edges = (obj.edges||[]).map(e => ({ a:String(e.a), b:String(e.b), w:+e.w }));
      S.sourceId = obj.sourceId ? String(obj.sourceId) : (S.nodes[0]?.id || null);
      Utils.circleLayoutIfMissing(S.nodes, 1600, 900, 320);
      refresh();
    }

    savePresetBtn.onclick = () => {
      presetBox.value = exportPreset();
    };

    copyPresetBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(exportPreset());
        alert('Copiado.');
      } catch {
        alert('No se pudo copiar.');
      }
    };

    loadPresetBtn.onclick = () => {
      try {
        importPreset(presetBox.value);
      } catch {
        alert('Preset inválido.');
      }
    };

    resetBtn.onclick = () => {
      S.nodes = [];
      S.edges = [];
      S.sourceId = null;
      Utils.recomputeAndRender();
      window.dispatchEvent(new CustomEvent('graph-changed'));
    };

    /* Sidebar Resizer */
    (function setupResizer(){
      const resizer = document.getElementById('sidebar-resizer');
      const root = document.documentElement;
      let startX = 0, startWidth = 0, dragging = false;

      resizer.addEventListener('mousedown', e => {
        dragging = true;
        startX = e.clientX;
        const styles = getComputedStyle(root);
        startWidth = parseFloat(styles.getPropertyValue('--drawer-width'));
        resizer.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        e.preventDefault();
      });

      window.addEventListener('mousemove', e => {
        if (!dragging) return;
        const dx = startX - e.clientX;
        let newW = Math.min(800, Math.max(260, startWidth + dx));
        root.style.setProperty('--drawer-width', newW + 'px');
      });

      window.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        resizer.classList.remove('active');
        document.body.style.cursor = 'default';
      });
    })();

    /* Help Overlay [Button -> SVG opens -> Esc/Click to close{Click/Key listeners}] */
    /* Locks Editor until closing */
    (function setupHelpOverlay(){
      const btn = document.getElementById('helpBtn');
      const overlay = document.getElementById('helpOverlay');
      const img = overlay.querySelector('img');
      const S = Utils.state;

      function openHelp(){
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden','false');
        S.modalOpen = true;
      }
      function closeHelp(){
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden','true');
        S.modalOpen = false;
        img.style.transform = 'scale(1)';
      }

      btn.addEventListener('click', openHelp);

      overlay.addEventListener('mousedown', (e)=>{
        if (e.target === overlay) { e.stopPropagation(); e.preventDefault(); closeHelp(); }
        else { e.stopPropagation(); }
      }, true);

      window.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && overlay.classList.contains('active')){
          e.preventDefault();
          closeHelp();
        }
      }, true);

      overlay.addEventListener('mousemove', (e)=>{
        if (!S.modalOpen) return;
        const r = overlay.getBoundingClientRect();
        const nx = (e.clientX - r.width/2) / r.width;
        const ny = (e.clientY - r.height/2) / r.height;
        const moveX = nx * 22, moveY = ny * 22;
        const tiltX = ny * 7,  tiltY = -nx * 7;
        img.style.transition = 'transform .05s ease-out';
        img.style.transform = `translate(${moveX}px,${moveY}px) rotateX(${tiltX}deg) rotateY(${tiltY}deg) scale(1.03)`;
      });
      overlay.addEventListener('mouseleave', ()=>{
        if (!S.modalOpen) return;
        img.style.transform = 'scale(1)';
      });
    })();

    /* Initial paint */
    refresh();
  })();
</script>

<script src="editor.js"></script>

</body>
</html>
